#!/bin/bash
# usage examples:
# qrauth
# qrauth && sudo -i

#set +e
#TTY=/dev/stdout
TTY=/dev/stderr
NUL=/dev/null
HTTPPORT=8080
QRAUTHFN="qrauth.txt"
PTPPATH="/store_00010001/Pictures"

SELFPID=$$
SESSPUBKEY="SESSPUBKEY"
cd /tmp


KEYRING_ID=`keyctl search @u user "$SESSPUBKEY" 2>$NUL`
if [ ! -z "$KEYRING_ID" ]; then
  keyctl unlink $KEYRING_ID >$TTY
fi

KEYRING_ID=`age-keygen 2>$NUL | grep AGE-SECRET-KEY | keyctl padd user "$SESSPUBKEY" @u`
PUBKEY=`keyctl pipe $KEYRING_ID | age-keygen -y`

USBIFCIP="0.0.0.0"
for interface in /sys/class/net/*; do
  ifc=$(readlink "$interface")
  if [[ "$ifc" == */usb* ]] >$TTY; then
    ifcn=${interface#/sys/class/net/}
    USBIFCIP=$(ifconfig $ifcn | grep netmask | awk '{print $2}' | tr -d '\n')
    echo "">$TTY
    echo "USB network interface IP: $USBIFCIP">$TTY
  fi
done

HOSTNAME=$(hostname)
WHOAMI=$(whoami)
if [ -z "$HOSTNAME" ]; then
  HOSTNAME="HOSTNAME"
fi

str2OTPsecret() {
  OTPHEX=`echo -n "$1" | sha256sum | sed 's/ .*$//'`

  strbin=`for i in $(echo $OTPHEX | sed 's/../& /g'); do
    HEX=$(echo $i | tr 'a-f' 'A-F')
    BIN=$(echo "obase=2; ibase=16; ${HEX}" | bc)
    bin=$(printf "%08d" ${BIN})
    echo -n "$bin"
  done`

  OTPsecret=`BASE32='ABCDEFGHIJKLMNOPQRSTUVWXYZ234567'
  LEN=32
  for i in $(echo $strbin | sed 's/...../& /g'); do
    b=$(echo "obase=10; ibase=2; ${i}" | bc)
    b=$((b+1))
    b32=$(echo "$BASE32" | cut -c$b)
    echo -n "$b32"
    LEN=$((LEN-1))
    if [ $LEN -le 0 ]; then
      break
    fi
  done`
  echo -n "$OTPsecret"
}

PUBKEY=111/$HOSTNAME/qrauth/$WHOAMI/$USBIFCIP:$HTTPPORT/$PUBKEY
ISPTPMODE=0
if [ -e /usr/bin/gphoto2 ]; then
  echo -n "$PUBKEY">$QRAUTHFN
  gphoto2 -q -f $PTPPATH -d $QRAUTHFN 2>$NUL 1>$NUL
  gphoto2 -q --force-overwrite -f $PTPPATH -u $QRAUTHFN 2>$NUL 1>$NUL
  if [ $? -eq 0 ]; then
    ISPTPMODE=${#PUBKEY}
    echo "USB PTP Mode is active! Now you could enable USB mode switcher in PWA UI">$TTY
  fi
fi
echo "QR data: [$PUBKEY]">$TTY
qrencode -m 2 -t ANSI256UTF8 "$PUBKEY">$TTY
CC=`str2OTPsecret $PUBKEY | oathtool -c 1 -d 6 -b --hotp -`
CC="${CC:0:3}-${CC:3}"
echo "QRC data control code:  $CC  :  $CC  :  $CC  :  $CC  :  $CC  :  $CC  :  $CC">$TTY
echo "and now 62 countdown seconds of waiting the passkey via QR codes (or press Ctrl+C)...">$TTY


zbarfifo=/tmp/zbarcam.fifo
rm -f $zbarfifo >$NUL
test -e $zbarfifo || mkfifo $zbarfifo >$NUL
httpfifo=/tmp/qrauth.http.fifo
rm -f $httpfifo >$NUL
test -e $httpfifo || mkfifo $httpfifo >$NUL


ZBARPID=0
TIMEOUTPID=0
FIFOPID=0
TERMFLAG=$(mktemp)
rm -f $TERMFLAG 2>$NUL 1>$NUL
terminate() {
  if [ -e $TERMFLAG ]; then
    return 0
  fi
  touch $TERMFLAG

  NCPID=`ps -Af | egrep "nc -l -p $HTTPPORT" | grep -v grep | awk '{print $2}'`
  if [ ! -z "$NCPID" ]; then
    kill -9 $NCPID 2>$NUL 1>$NUL
    wait $NCPID 2>$NUL 1>$NUL
    echo ".">$httpfifo
  fi

  kill -9 $FIFOPID 2>$NUL 1>$NUL
  wait $FIFOPID 2>$NUL 1>$NUL

  ISTOPID=`ps -A | grep $TIMEOUTPID`
  if [ ! -z "$ISTOPID" -a $TIMEOUTPID -ne 0 ]; then
    kill -9 $TIMEOUTPID 2>$NUL 1>$NUL
    wait $TIMEOUTPID 2>$NUL 1>$NUL
  fi

  rm -f $httpfifo >$NUL
  rm -f $zbarfifo >$NUL

  kill -9 $ZBARPID 2>$NUL 1>$NUL
  wait $ZBARPID 2>$NUL

  keyctl unlink $KEYRING_ID >$NUL
  echo "">$TTY

  rm -f $TERMFLAG 2>$NUL 1>$NUL

  if [ -z "$1" ]; then
    echo "Terminated.">$TTY
    exit 1
  fi
}
trap terminate INT TERM


qrdatafn=$(mktemp)
QRdataComplete() {
  echo "$1" | base64 -d >$qrdatafn
  keyctl pipe $KEYRING_ID | age -d -i - $qrdatafn | keyctl pupdate $KEYRING_ID  # workaround: because breaks from this WHILE does kill all VARS
  rm $qrdatafn
  return 0
}

if [ "$USBIFCIP" != "0.0.0.0" ]; then
{
cat $httpfifo | nc -l -p $HTTPPORT | grep --line-buffered GET | \
while read -r GET; do
  if [ "$GET" == "." ]; then
    break
  fi
  data=${GET##*&}
  QRDATA=${data% *}
  echo -e "HTTP/1.1 200 OK\r\nContent-Type: text/plain\r\nContent-Length: 2\r\nAccess-Control-Allow-Origin: *\r\n\r\nOK" >$httpfifo
  QRdataComplete $QRDATA
  break
done
echo ".">$zbarfifo
} &
FIFOPID=$!
fi

zbarcam -q --nodisplay --nodbus --raw -Sdisable -Sqrcode.enable >$zbarfifo 2>$TTY &
ZBARPID=$!

BASE62="0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz"
TIMEOUT=62
(while [ -e $httpfifo -a $TIMEOUT -gt 0 ]>$NUL; do
  sleep 1 >$NUL
  echo "$BASE62" | cut -zc$TIMEOUT >$TTY
  TIMEOUT=$((TIMEOUT-1))
  if [ $ISPTPMODE -ne 0 ]; then
    QRDATA=`gphoto2 -q --force-overwrite -f $PTPPATH -p $QRAUTHFN --stdout 2>$TTY`
    DATASIZE=${#QRDATA}
    if [ ! -z "$QRDATA" -a $DATASIZE -gt $ISPTPMODE ]; then
      QRdataComplete $QRDATA
      gphoto2 -q -f $PTPPATH -d $QRAUTHFN 2>$NUL 1>$NUL
      break
    fi
  fi
 done
 echo ".">$zbarfifo
 if [ $TIMEOUT -eq 0 ]; then echo "...timeout exceeded.">$TTY; fi
)&
TIMEOUTPID=$!


ISVIDEODEV=`ls /dev/video* 2>$NUL`
if [ -z "$ISVIDEODEV" ]; then
  echo -e "\n###\n###">$TTY
  echo "### No video camera found!" >$TTY
  echo "###">$TTY
  if [ "$USBIFCIP" == "0.0.0.0" -a $ISPTPMODE -eq 0 ]; then
    echo "### Please enable USB modem or PTP mode on PWA device and try again." >$TTY
    echo "### (press Ctrl+Alt+Delete for reboot)" >$TTY
    echo -e "###\n###\n">$TTY
    terminate 2>$NUL 1>$NUL
    exit 1
  fi
fi
LEN=0
CNTR=""
while read -r QRCHUNK <$zbarfifo; do
  if [ "$QRCHUNK" == "." ]; then
    break
  fi
  NDGTS=`echo $QRCHUNK | cut -c 1`
  NCHUNKS=`echo $QRCHUNK | cut -c 2-$((NDGTS+1))`
  ICHUNK=`echo $QRCHUNK | cut -c $((NDGTS+2))-$((NDGTS*2+1))`
  echo " ">$TTY
  echo -n "{$ICHUNK/$NCHUNKS: ">$TTY
  ICHUNK=$(echo "obase=10; ibase=10; ${ICHUNK}" | bc)
  QRCHUNK=`echo "$QRCHUNK" | cut -c $((NDGTS*2+2))-`
  f=$(echo "$BASE62" | cut -c$ICHUNK)
  if echo "$CNTR" | grep -q $f; then
    echo -n "$LEN} # ">$TTY
  else
    CNTR=$CNTR$f
    VARCHUNK="QRCHUNK$ICHUNK"
    eval "$VARCHUNK=\"$QRCHUNK\""
    LEN=$((LEN+1))
    echo -n "$LEN} ">$TTY
  fi
  if [ $LEN -eq $NCHUNKS ]>$NUL; then
    QRDATA=""
    while [ $LEN -gt 0 ]; do
      VARCHUNK="QRCHUNK$LEN"
      eval "VAR=\$${VARCHUNK}"
      QRDATA=$VAR$QRDATA
      LEN=$((LEN-1))
    done

    QRdataComplete $QRDATA
    break
  fi
done


if [ ! -z "$KEYRING_ID" -a ! -e $qrdatafn ]; then
ISKEYID=`keyctl show @u | grep $KEYRING_ID 2>$NUL`
if [ ! -z "$ISKEYID" ]; then
  PASSKEY=`keyctl pipe $KEYRING_ID`
  NL="
"
  CURRPASS=${PASSKEY%$NL*}
  NEWPASS=${PASSKEY##*$NL}
  echo -n "$CURRPASS" | sudo -S -v 2>$NUL 1>$NUL
  if [ "$?" -ne 0 ]; then
  echo "">$TTY
  echo "### !!! The received password is not valid, try again !!! ###" >$TTY
  else
    if [ "$CURRPASS" != "$NEWPASS" ]; then
      echo "$WHOAMI:$NEWPASS" | sudo chpasswd >$TTY
      echo "New password for $WHOAMI is applied" >$TTY
    fi
    echo "">$TTY
    echo "Now may execute \"sudo -i\" to get the root... (15sec)" >$TTY
  fi
fi
else
rm $qrdatafn
terminate 2>$NUL 1>$NUL
fi

terminate ~ 2>$NUL 1>$NUL &
exit 0
